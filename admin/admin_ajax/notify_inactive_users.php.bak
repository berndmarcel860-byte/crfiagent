<?php
/**
 * Notify Inactive Users
 * Sends email notifications to users who have been inactive for a specified period
 */
require_once '../admin_session.php';
require_once '../email_template_helper.php';

header('Content-Type: application/json');

try {
    // Get parameters
    $inactiveDays = isset($_POST['inactive_days']) ? (int)$_POST['inactive_days'] : 30;
    $emailTemplate = $_POST['email_template'] ?? 'inactive_user_reminder';
    
    // Select appropriate template based on inactive days if not specified
    if (!isset($_POST['email_template'])) {
        if ($inactiveDays >= 60) {
            $emailTemplate = 'inactive_user_60_days';
        } elseif ($inactiveDays >= 30) {
            $emailTemplate = 'inactive_user_30_days';
        } elseif ($inactiveDays >= 7) {
            $emailTemplate = 'inactive_user_7_days';
        } else {
            $emailTemplate = 'inactive_user_reminder';
        }
    }
    
    // Find inactive users
    $stmt = $pdo->prepare("
        SELECT 
            u.id,
            u.email,
            u.first_name,
            u.last_name,
            u.last_login,
            DATEDIFF(NOW(), u.last_login) as days_inactive
        FROM users u
        WHERE u.last_login < DATE_SUB(NOW(), INTERVAL ? DAY)
            AND u.status = 'active'
            AND u.is_verified = 1
        ORDER BY u.last_login ASC
        LIMIT 100
    ");
    $stmt->execute([$inactiveDays]);
    $inactiveUsers = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    if (empty($inactiveUsers)) {
        echo json_encode([
            'success' => true,
            'message' => 'No inactive users found',
            'count' => 0
        ]);
        exit;
    }
    
    // Initialize email template helper
    $emailHelper = new EmailTemplateHelper($pdo);
    
    $sentCount = 0;
    $failedCount = 0;
    $errors = [];
    
    // Send emails to inactive users
    foreach ($inactiveUsers as $user) {
        try {
            // Prepare template variables
            $variables = [
                'user_id' => $user['id'],
                'first_name' => $user['first_name'],
                'last_name' => $user['last_name'],
                'email' => $user['email'],
                'days_inactive' => $user['days_inactive'],
                'login_url' => 'https://' . $_SERVER['HTTP_HOST'] . '/login.php',
                'analysis_count' => rand(50, 200),
                'case_number' => 'CASE-' . str_pad($user['id'], 6, '0', STR_PAD_LEFT),
                'support_email' => 'support@fundtracerai.com'
            ];
            
            // Send email using template
            $success = $emailHelper->sendTemplateEmail(
                $user['email'],
                $emailTemplate,
                $variables
            );
            
            if ($success) {
                $sentCount++;
            } else {
                $failedCount++;
                $errors[] = "Failed to send to: {$user['email']}";
            }
            
        } catch (Exception $e) {
            $failedCount++;
            $errors[] = "Error sending to {$user['email']}: " . $e->getMessage();
        }
    }
    
    echo json_encode([
        'success' => true,
        'message' => "Sent {$sentCount} emails successfully. {$failedCount} failed.",
        'sent' => $sentCount,
        'failed' => $failedCount,
        'total_users' => count($inactiveUsers),
        'template_used' => $emailTemplate,
        'errors' => $errors
    ]);
    
} catch (Exception $e) {
    http_response_code(500);
    echo json_encode([
        'success' => false,
        'message' => 'Error: ' . $e->getMessage()
    ]);
}
